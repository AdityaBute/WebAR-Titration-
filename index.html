<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MindAR Titration Project</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  </head>

  <body style="margin: 0; overflow: hidden;">
    
    <a-scene mindar-image="imageTargetSrc: ./assets/targets.mind; autoStart: true;" 
             color-space="sRGB" 
             renderer="colorManagement: true, physicallyCorrectLights" 
             vr-mode-ui="enabled: false" 
             device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <a-asset-item id="lab-kit" src="./assets/titration_final.glb"></a-asset-item>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false" cursor="fuse: false; rayOrigin: mouse;" raycaster="objects: .clickable"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0">
        <a-gltf-model id="titration-setup" 
                      src="#lab-kit" 
                      class="clickable" 
                      scale="0.5 0.5 0.5" 
                      position="0 0 0">
        </a-gltf-model>
      </a-entity>
    </a-scene>

    <script>
      const setup = document.querySelector('#titration-setup');
      let dropCount = 0;
      let isAnimating = false;

      // SETUP: Hide the Pink liquid as soon as the model loads!
      setup.addEventListener('model-loaded', () => {
         const mesh = setup.getObject3D('mesh');
         if (mesh) {
             const pinkLiquid = mesh.getObjectByName('Liquid_Pink');
             if (pinkLiquid) pinkLiquid.visible = false; 
         }
      });

      // CLICK EVENT: The Simulation
      setup.addEventListener('click', () => {
        if (isAnimating) return; 

        const mesh = setup.getObject3D('mesh');
        if (!mesh) return;

        // GRABBING YOUR EXACT BLENDER NAMES
        const drop = mesh.getObjectByName('Sphere.001'); 
        const clearLiquid = mesh.getObjectByName('Liquid_Clear'); 
        const pinkLiquid = mesh.getObjectByName('Liquid_Pink'); 
        
        dropCount++;
        console.log("Drops added: " + dropCount);

        // --- THE FALLING DROP ANIMATION ---
        if (drop) {
          isAnimating = true;
          drop.visible = true; 
          
          const startY = drop.position.y;
          let step = 0;
          
          const fallInterval = setInterval(() => {
            drop.position.y -= 0.02; // Speed of the drop
            step++;
            
            if (step > 25) { 
              clearInterval(fallInterval);
              drop.position.y = startY; // Reset to top
              drop.visible = false;     // Hide drop
              isAnimating = false;

              // --- THE 7-CLICK ENDPOINT ---
              if (dropCount === 7) {
                if (clearLiquid) clearLiquid.visible = false; // Hide clear
                if (pinkLiquid) pinkLiquid.visible = true;    // Show pink
                console.log("Titration Complete! Equivalence point reached.");
              }
            }
          }, 20); // 20ms per frame
        }
      });
    </script>
  </body>
</html>
