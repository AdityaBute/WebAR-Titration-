<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MindAR Titration Project</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  </head>

  <body style="margin: 0; overflow: hidden;">
    
    <a-scene mindar-image="imageTargetSrc: ./assets/targets.mind; autoStart: true;" 
             color-space="sRGB" 
             renderer="colorManagement: true, physicallyCorrectLights" 
             vr-mode-ui="enabled: false" 
             device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <a-asset-item id="lab-kit" src="./assets/titration_final.glb"></a-asset-item>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false" cursor="fuse: false; rayOrigin: mouse;" raycaster="objects: .clickable"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0">
        <a-gltf-model id="titration-setup" 
                      src="#lab-kit" 
                      class="clickable" 
                      scale="0.5 0.5 0.5" 
                      position="0 0 0">
        </a-gltf-model>
      </a-entity>
    </a-scene>

    <script>
      const setup = document.querySelector('#titration-setup');
      let dropCount = 0;
      let isAnimating = false;

      setup.addEventListener('click', () => {
        // Prevent clicking again while a drop is currently falling
        if (isAnimating) return; 

        // Grab the internal 3D meshes from your Blender file
        const mesh = setup.getObject3D('mesh');
        if (!mesh) return;

        // CRITICAL: These names MUST match what you named them in Blender's outliner!
        const drop = mesh.getObjectByName('Burette_Drop'); 
        const liquid = mesh.getObjectByName('Liquid_Clear'); // or whatever you named the flask liquid
        
        dropCount++;
        console.log("Drop count: " + dropCount);

        // --- ANIMATION LOGIC ---
        if (drop) {
          isAnimating = true;
          // Unhide the drop if you hid it in Blender
          drop.visible = true; 
          
          const startY = drop.position.y;
          let step = 0;
          
          // Move the drop down slightly every 20 milliseconds
          const fallInterval = setInterval(() => {
            drop.position.y -= 0.02; // Adjust this number if it falls too fast/slow
            step++;
            
            // After 25 steps, reset the drop back to the top
            if (step > 25) { 
              clearInterval(fallInterval);
              drop.position.y = startY; 
              drop.visible = false; // Hide it again
              isAnimating = false;

              // --- 7-CLICK COLOR LOGIC ---
              if (dropCount === 7 && liquid) {
                // Change the liquid material to Pink (#FF1493)
                liquid.material.color.set('#FF1493'); 
                console.log("Titration Complete! Liquid is Pink.");
              }
            }
          }, 20);
        } else {
            // Backup in case the drop isn't found, but we still want the 7th click to work
            isAnimating = false;
            if (dropCount === 7 && liquid) {
                liquid.material.color.set('#FF1493');
            }
        }
      });
    </script>
  </body>
</html>
